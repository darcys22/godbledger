// Package components defines utilities to spin up actual
// beacon node and validator processes as needed by end to end tests.
package components

import (
	"os/exec"
	"runtime"

	//"strings"
	"fmt"
	"strings"
	"testing"

	"github.com/darcys22/godbledger/godbledger/cmd"
	"github.com/darcys22/godbledger/tests/helpers"
	e2e "github.com/darcys22/godbledger/tests/params"
)

func StartGoDBLedger(t *testing.T, config *cmd.LedgerConfig) int {
	stdOutFile, err := helpers.DeleteAndCreateFile("", e2e.LogFileName)

	if err != nil {
		t.Fatal(err)
	}

	args := []string{
		fmt.Sprintf("--log-file=%s", stdOutFile.Name()),
		"--verbosity=trace",
		fmt.Sprintf("--rpc-host=%s", config.Host),
		fmt.Sprintf("--rpc-port=%s", config.RPCPort),
		fmt.Sprintf("--database=%s", config.DatabaseType),
		fmt.Sprintf("--database-location=%s", config.DatabaseLocation),
	}

	binPath := fmt.Sprintf("../release/godbledger-%s-x64-vlatest/godbledger", runtime.GOOS)
	cmd := exec.Command(binPath, args...)
	t.Logf("Starting GoDBLedger (%s) with flags: %s", binPath, strings.Join(args[:], " "))
	if err := cmd.Start(); err != nil {
		t.Fatalf("Failed to start GoDBLedger Server: %v", err)
	}

	if err := helpers.WaitForTextInFile(stdOutFile, "GRPC Listening on port"); err != nil {
		t.Fatalf("could not find GRPC starting for server, this means the server had issues starting: %v", err)
	}

	return cmd.Process.Pid
}
